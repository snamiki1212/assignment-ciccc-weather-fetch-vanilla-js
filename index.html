<!DOCTYPE html>
<html>

<head>
  <script>
    "use strict"
    // options
    const defaultCityName = 'vancouver';
    const API_KEY = "b2b86779f50b9bf6a8c0808905029f25"
    const RETRY_DURATION_MILLISECOND = 1_000 * 60 * 2;

    // APIs
    const PREFIX_URL = "https://api.openweathermap.org/data/2.5/"
    const SUFFIX_URL = `&appid=${API_KEY}`;
    const getWeatherUrl = (cityName) => PREFIX_URL + `weather?q=${cityName}` + SUFFIX_URL

    // Weather Object
    const selectWeatherMain = weatherObj => weatherObj.weather[0].main
    const selectWeatherDescription = weatherObj => weatherObj.weather[0].description
    const selectFeelsLike = weatherObj => weatherObj.main?.feels_like
    const selectCityName = weatherObj => weatherObj.name;

    // DOM manipulator
    const render = (parentDOM, { cityName, weatherMain, weatherDescription, feelsLike }) => {
      parentDOM.innerHTML = ""

      // weatherMain
      const cityNameDOM = document.createElement('li')
      cityNameDOM.innerHTML = `cityName: ${cityName}`
      parentDOM.appendChild(cityNameDOM);

      // weatherMain
      const weatherMainDOM = document.createElement('li')
      weatherMainDOM.innerHTML = `weatherMain: ${weatherMain}`
      parentDOM.appendChild(weatherMainDOM);

      // weatherMain
      const weatherDescriptionDOM = document.createElement('li')
      weatherDescriptionDOM.innerHTML = `weatherDescription: ${weatherDescription}`
      parentDOM.appendChild(weatherDescriptionDOM);

      // feel like
      const feelLikeDOM = document.createElement('li')
      feelLikeDOM.innerHTML = `feelsLike: ${feelsLike}`
      parentDOM.appendChild(feelLikeDOM);

      // meta
      const lastUpdatedDOM = document.createElement('li')
      lastUpdatedDOM.innerHTML = `last updated: ${(new Date().toISOString())}`
      parentDOM.appendChild(lastUpdatedDOM);

      return parentDOM
    }

    window.addEventListener("DOMContentLoaded", () => {
      // DOMs
      const inputDOM = document.querySelector('.input');
      const buttonDOM = document.querySelector('.button');
      const descriptionDOM = document.querySelector('.description');

      // mut params
      let lastSearchedUrl = getWeatherUrl(defaultCityName);

      const searchWeather = async (url) => {
        console.log(">> start search weather. | url:", url);

        try {
          const res = await fetch(url)
          if (res.status === 404) {
            alert("maybe, city not found")
            return;
          }
          if (res.status !== 200) {
            throw new Error(res.body)
          }

          // weather obj parser
          const weatherObj = await res.json()
          const cityName = selectCityName(weatherObj)
          const weatherMain = selectWeatherMain(weatherObj)
          const weatherDescription = selectWeatherDescription(weatherObj)
          const feelsLike = selectFeelsLike(weatherObj);

          // rendering
          const params = {
            cityName,
            weatherMain,
            weatherDescription,
            feelsLike,
          }
          render(descriptionDOM, params)

          lastSearchedUrl = url;
        } catch (err) {
          console.error("SOMETHING ERROR HAPPEN: ", err);
        }
      }

      const init = () => {
        buttonDOM.addEventListener('click', () => {
          const maybeCityName = inputDOM.value
          const url = getWeatherUrl(maybeCityName);
          searchWeather(url)
        })

        setInterval(() => {
          searchWeather(lastSearchedUrl);
        }, RETRY_DURATION_MILLISECOND)

        searchWeather(getWeatherUrl(defaultCityName))
      }

      init();
    });

  </script>
</head>

<body>
  <input class="input" placeholder="e.g. Vancouver" />
  <button class="button">Search</button>
  <div class="description">
    <!-- REPLACE_ME_BY_JS -->
  </div>
</body>

</html>